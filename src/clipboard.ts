import * as fs from "node:fs";
import * as path from "node:path";
import * as fswin from "fswin";

import { hostName } from "./global";
import { deleteFolderRecursive, iterateThroughFilesRecursively } from "./utils";

// returns 0 if not valid
export const getItemNumber = (
  file: string,
  filter: "none" | "from-others" | "from-myself" = "none"
) => {
  const parsedFile = path.parse(file);
  let itemNumber = 0;
  let fileStat;

  try {
    fileStat = fs.lstatSync(file);
  } catch (error) {
    return itemNumber;
  }

  if (fileStat.isDirectory()) {
    const match = parsedFile.base.match(
      /^(0|[1-9][0-9]*)-([0-9a-zA-Z-]+)\.(0|[1-9][0-9]*)_files$/
    );
    if (match) {
      switch (filter) {
        case "from-myself":
          if (match[2] === hostName) {
            itemNumber = parseInt(match[1]);
          }
          break;
        case "from-others":
          if (match[2] !== hostName) {
            itemNumber = parseInt(match[1]);
          }
          break;
        default:
          itemNumber = parseInt(match[1]);
          break;
      }
    }
  } else {
    const match = parsedFile.base.match(
      /^(0|[1-9][0-9]*)-([0-9a-zA-Z-]+)\.(txt|png)$/
    );
    if (match) {
      switch (filter) {
        case "from-myself":
          if (match[2] === hostName) {
            itemNumber = parseInt(match[1]);
          }
          break;
        case "from-others":
          if (match[2] !== hostName) {
            itemNumber = parseInt(match[1]);
          }
          break;
        default:
          itemNumber = parseInt(match[1]);
          break;
      }
    }
  }
  return itemNumber;
};

export const getNextWriteTime = (syncFolder: string) => {
  const numbers: number[] = [];
  const files = fs.readdirSync(syncFolder);
  for (const file of files) {
    const filePath = path.join(syncFolder, file);
    const itemNumber = getItemNumber(filePath);
    if (itemNumber) {
      numbers.push(itemNumber);
    }
  }
  if (numbers.length > 0) {
    // https://stackoverflow.com/a/1063027/12156188
    return (
      numbers
        .sort((a, b) => {
          return a - b;
        })
        .at(-1) + 1
    );
  }
  return 1;
};

export const isThereMoreThanOneClipboardFile = (syncFolder: string) => {
  let found = 0;
  const files = fs.readdirSync(syncFolder);
  for (const file of files) {
    const filePath = path.join(syncFolder, file);
    const itemNumber = getItemNumber(filePath);
    if (itemNumber) {
      found++;
      if (found > 1) {
        return;
      }
    }
  }
  return found > 1;
};

export const isIsReceivingFile = (file: string) => {
  return file.endsWith(".is-receiving.txt");
};

// Unsyncs from-others files older than 1 minute,
// Removes from-myself files older than 5 minutes,
// And removes from-others files older than 10 minutes.
export const cleanFiles = (syncFolder: string) => {
  const now = Date.now();
  const currentTimeMinus1Min = now - 60000;
  const currentTimeMinus5Min = now - 300000;
  const currentTimeMinus10Min = now - 600000;
  const files = fs.readdirSync(syncFolder);
  for (const file of files) {
    const filePath = path.join(syncFolder, file);

    // These files will be deleted at application finish.
    if (isIsReceivingFile(filePath)) {
      break;
    }

    if (getItemNumber(filePath, "from-myself")) {
      const fileStat = fs.statSync(filePath);
      if (fileStat.ctime.getTime() <= currentTimeMinus5Min) {
        if (fileStat.isDirectory()) {
          deleteFolderRecursive(filePath);
        } else {
          fs.unlinkSync(filePath);
        }
      }
    } else if (getItemNumber(filePath, "from-others")) {
      const fileStat = fs.statSync(filePath);
      if (fileStat.ctime.getTime() <= currentTimeMinus1Min) {
        if (process.platform === "win32") {
          unsyncFileOrFolderRecursively(filePath);
        }
      } else if (fileStat.ctime.getTime() <= currentTimeMinus10Min) {
        if (fileStat.isDirectory()) {
          deleteFolderRecursive(filePath);
        } else {
          fs.unlinkSync(filePath);
        }
      }
    }
  }
};

export const unsyncFileOrFolderRecursively = (fileOrFolder: string) => {
  iterateThroughFilesRecursively([fileOrFolder], (file) => {
    fswin.setAttributesSync(file, {
      IS_UNPINNED: true,
      IS_PINNED: false,
    });
  });
};
